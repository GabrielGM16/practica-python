{% extends 'productos/base.html' %}

{% block title %}
    {% if modo == 'crear' %}Crear Producto{% else %}Editar Producto{% endif %} - Distribuidora
{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
        <i class="bi bi-{% if modo == 'crear' %}plus-circle{% else %}pencil{% endif %} mr-2"></i>
        {% if modo == 'crear' %}Crear Nuevo Producto{% else %}Editar Producto{% endif %}
    </h2>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
        <!-- Formulario Principal -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg">
                <h5 class="text-lg font-semibold flex items-center">
                    <i class="bi bi-info-circle mr-2"></i> Información del Producto
                </h5>
            </div>
            <div class="p-6">
                <form id="productoForm" class="space-y-4">
                    <div>
                        <label for="clave" class="block text-sm font-medium text-gray-700 mb-2">
                            Clave <span class="text-red-500">*</span>
                        </label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="clave" required maxlength="50">
                        <div class="text-red-500 text-sm mt-1 hidden" id="clave-error">La clave es requerida</div>
                    </div>
                    
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
                            Nombre <span class="text-red-500">*</span>
                        </label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="nombre" required maxlength="200">
                        <div class="text-red-500 text-sm mt-1 hidden" id="nombre-error">El nombre es requerido</div>
                    </div>
                    
                    <div>
                        <label for="tipo_producto" class="block text-sm font-medium text-gray-700 mb-2">
                            Tipo de Producto <span class="text-red-500">*</span>
                        </label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="tipo_producto" required>
                            <option value="">Seleccione un tipo</option>
                        </select>
                        <div class="text-red-500 text-sm mt-1 hidden" id="tipo_producto-error">Debe seleccionar un tipo de producto</div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" id="activo" checked>
                        <label for="activo" class="ml-2 block text-sm text-gray-900">
                            Producto Activo
                        </label>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de Proveedores -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="bg-green-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
                <h5 class="text-lg font-semibold flex items-center">
                    <i class="bi bi-people mr-2"></i> Proveedores del Producto
                </h5>
                <button type="button" class="bg-white text-green-600 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100 transition-colors flex items-center" onclick="showModal('proveedorModal')">
                    <i class="bi bi-plus-circle mr-1"></i> Agregar Proveedor
                </button>
            </div>
            <div class="p-6">
                <div id="noProveedores" class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-md">
                    <i class="bi bi-info-circle mr-2"></i> No hay proveedores asignados. Agregue al menos uno.
                </div>
                
                <div id="proveedoresTable" style="display: none;">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clave Proveedor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departamento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Costo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="proveedoresBody" class="bg-white divide-y divide-gray-200">
                                <!-- Se llenará con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel Lateral -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-md sticky top-6">
            <div class="bg-gray-600 text-white px-6 py-4 rounded-t-lg">
                <h5 class="text-lg font-semibold flex items-center">
                    <i class="bi bi-gear mr-2"></i> Acciones
                </h5>
            </div>
            <div class="p-6">
                <div class="space-y-3">
                    <button type="button" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-md font-medium text-lg transition-colors flex items-center justify-center" id="btnGuardar">
                        <i class="bi bi-save mr-2"></i> Guardar Producto
                    </button>
                    <a href="{% url 'producto_list' %}" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md font-medium transition-colors inline-flex items-center justify-center">
                        <i class="bi bi-arrow-left mr-2"></i> Cancelar
                    </a>
                </div>
                
                <hr class="my-4">
                
                <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-md">
                    <div class="text-sm">
                        <i class="bi bi-exclamation-triangle mr-1"></i>
                        <strong>Nota:</strong> Los campos marcados con <span class="text-red-500">*</span> son obligatorios.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Proveedor -->
<div id="proveedorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="bg-green-600 text-white px-4 py-3 rounded-t-md flex justify-between items-center">
            <h5 class="font-semibold flex items-center">
                <i class="bi bi-person-plus mr-2"></i> Agregar Proveedor
            </h5>
            <button onclick="closeModal('proveedorModal')" class="text-white hover:text-gray-200 focus:outline-none">
                <i class="bi bi-x text-xl"></i>
            </button>
        </div>
        <div class="p-4">
            <form id="proveedorForm" class="space-y-4">
                <div>
                    <label for="modal_departamento" class="block text-sm font-medium text-gray-700 mb-2">
                        Departamento
                    </label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" id="modal_departamento">
                        <option value="">Todos los departamentos</option>
                    </select>
                </div>
                
                <div>
                    <label for="modal_proveedor" class="block text-sm font-medium text-gray-700 mb-2">
                        Proveedor <span class="text-red-500">*</span>
                    </label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" id="modal_proveedor" required>
                        <option value="">Seleccione un proveedor</option>
                    </select>
                </div>
                
                <div>
                    <label for="modal_clave_proveedor" class="block text-sm font-medium text-gray-700 mb-2">
                        Clave del Proveedor <span class="text-red-500">*</span>
                    </label>
                    <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" id="modal_clave_proveedor" required maxlength="100">
                    <p class="text-sm text-gray-500 mt-1">Clave del producto según el proveedor</p>
                </div>
                
                <div>
                    <label for="modal_costo" class="block text-sm font-medium text-gray-700 mb-2">
                        Costo <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">$</span>
                        <input type="number" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" id="modal_costo" step="0.01" min="0.01" required>
                    </div>
                </div>
            </form>
        </div>
        <div class="flex justify-end space-x-2 p-4 border-t">
            <button onclick="closeModal('proveedorModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md font-medium transition-colors">
                Cancelar
            </button>
            <button id="btnAgregarProveedor" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium transition-colors flex items-center">
                <i class="bi bi-check-circle mr-2"></i> Agregar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const API_BASE_URL = '/productos/api';
    const MODO = '{{ modo }}';
    const PRODUCTO_ID = {{ producto_id|default:'null' }};
    
    let proveedoresList = [];
    let proveedoresData = [];
    let tiposProducto = [];
    let departamentosList = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        cargarTiposProducto();
        cargarProveedores();
        cargarDepartamentos();
        
        if (MODO === 'editar' && PRODUCTO_ID) {
            cargarProducto(PRODUCTO_ID);
        }
        
        // Event listeners
        document.getElementById('btnGuardar').addEventListener('click', guardarProducto);
        document.getElementById('btnAgregarProveedor').addEventListener('click', agregarProveedor);
        document.getElementById('modal_departamento').addEventListener('change', filtrarProveedoresPorDepartamento);
    });

    async function cargarTiposProducto() {
        try {
            const response = await fetch(`${API_BASE_URL}/tipos-producto/`);
            tiposProducto = await response.json();
            
            const select = document.getElementById('tipo_producto');
            tiposProducto.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.id;
                option.textContent = tipo.nombre;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error al cargar tipos de producto:', error);
            Swal.fire('Error', 'No se pudieron cargar los tipos de producto', 'error');
        }
    }

    async function cargarProveedores() {
        try {
            const response = await fetch(`${API_BASE_URL}/proveedores/`);
            proveedoresList = await response.json();
            
            actualizarSelectProveedores();
        } catch (error) {
            console.error('Error al cargar proveedores:', error);
            Swal.fire('Error', 'No se pudieron cargar los proveedores', 'error');
        }
    }

    async function cargarDepartamentos() {
        try {
            const response = await fetch(`${API_BASE_URL}/proveedores/departamentos/`);
            const data = await response.json();
            
            // La API devuelve un objeto con la propiedad 'departamentos' que contiene el array
            departamentosList = data.departamentos || [];
            
            const select = document.getElementById('modal_departamento');
            if (Array.isArray(departamentosList)) {
                departamentosList.forEach(departamento => {
                    const option = document.createElement('option');
                    option.value = departamento;
                    option.textContent = departamento;
                    select.appendChild(option);
                });
            } else {
                console.error('La respuesta de departamentos no es un array:', departamentosList);
                throw new Error('Formato de respuesta inválido');
            }
        } catch (error) {
            console.error('Error al cargar departamentos:', error);
            Swal.fire('Error', 'No se pudieron cargar los departamentos', 'error');
        }
    }

    function actualizarSelectProveedores() {
        const select = document.getElementById('modal_proveedor');
        const departamentoSeleccionado = document.getElementById('modal_departamento').value;
        
        // Limpiar opciones existentes excepto la primera
        select.innerHTML = '<option value="">Seleccione un proveedor</option>';
        
        // Filtrar proveedores según departamento seleccionado
        const proveedoresFiltrados = departamentoSeleccionado 
            ? proveedoresList.filter(proveedor => proveedor.departamento === departamentoSeleccionado)
            : proveedoresList;
        
        proveedoresFiltrados.forEach(proveedor => {
            const option = document.createElement('option');
            option.value = proveedor.id;
            option.textContent = proveedor.nombre;
            select.appendChild(option);
        });
    }

    function filtrarProveedoresPorDepartamento() {
        actualizarSelectProveedores();
    }

    async function cargarProducto(id) {
        try {
            const response = await fetch(`${API_BASE_URL}/productos/${id}/`);
            const producto = await response.json();
            
            // Llenar formulario
            document.getElementById('clave').value = producto.clave;
            document.getElementById('nombre').value = producto.nombre;
            document.getElementById('tipo_producto').value = producto.tipo_producto;
            document.getElementById('activo').checked = producto.activo;
            
            // Cargar proveedores
            if (producto.proveedores_detalle && producto.proveedores_detalle.length > 0) {
                proveedoresData = producto.proveedores_detalle.map(p => {
                    // Buscar el proveedor en la lista para obtener su departamento
                    const proveedorCompleto = proveedoresList.find(prov => prov.id === p.proveedor);
                    return {
                        proveedor: p.proveedor,
                        proveedor_nombre: p.proveedor_nombre,
                        proveedor_departamento: proveedorCompleto ? proveedorCompleto.departamento : 'N/A',
                        clave_proveedor: p.clave_proveedor,
                        costo: p.costo,
                        activo: p.activo
                    };
                });
                actualizarTablaProveedores();
            }
        } catch (error) {
            console.error('Error al cargar producto:', error);
            Swal.fire('Error', 'No se pudo cargar el producto', 'error');
        }
    }

    function agregarProveedor() {
        const proveedorId = document.getElementById('modal_proveedor').value;
        const claveProveedor = document.getElementById('modal_clave_proveedor').value.trim();
        const costo = document.getElementById('modal_costo').value;
        
        if (!proveedorId || !claveProveedor || !costo) {
            Swal.fire('Advertencia', 'Por favor complete todos los campos', 'warning');
            return;
        }
        
        // Verificar si ya existe
        if (proveedoresData.some(p => p.proveedor == proveedorId)) {
            Swal.fire('Advertencia', 'Este proveedor ya está asignado al producto', 'warning');
            return;
        }
        
        const proveedor = proveedoresList.find(p => p.id == proveedorId);
        
        proveedoresData.push({
            proveedor: parseInt(proveedorId),
            proveedor_nombre: proveedor.nombre,
            proveedor_departamento: proveedor.departamento,
            clave_proveedor: claveProveedor,
            costo: parseFloat(costo),
            activo: true
        });
        
        actualizarTablaProveedores();
        
        // Limpiar y cerrar modal
        document.getElementById('proveedorForm').reset();
        actualizarSelectProveedores(); // Restaurar todos los proveedores
        closeModal('proveedorModal');
        
        Swal.fire({
            icon: 'success',
            title: 'Proveedor agregado',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000
        });
    }

    function eliminarProveedor(index) {
        Swal.fire({
            title: '¿Eliminar proveedor?',
            text: '¿Está seguro de eliminar este proveedor del producto?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                proveedoresData.splice(index, 1);
                actualizarTablaProveedores();
                Swal.fire('Eliminado', 'Proveedor eliminado correctamente', 'success');
            }
        });
    }

    function actualizarTablaProveedores() {
        const noProveedores = document.getElementById('noProveedores');
        const proveedoresTable = document.getElementById('proveedoresTable');
        const proveedoresBody = document.getElementById('proveedoresBody');
        
        if (proveedoresData.length === 0) {
            noProveedores.style.display = 'block';
            proveedoresTable.style.display = 'none';
        } else {
            noProveedores.style.display = 'none';
            proveedoresTable.style.display = 'block';
            
            proveedoresBody.innerHTML = '';
            proveedoresData.forEach((prov, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${prov.clave_proveedor}</code></td>
                    <td>${prov.proveedor_nombre}</td>
                    <td><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${prov.proveedor_departamento || 'N/A'}</span></td>
                    <td><strong>$${parseFloat(prov.costo).toFixed(2)}</strong></td>
                    <td>
                        <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors inline-flex items-center" onclick="eliminarProveedor(${index})" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                proveedoresBody.appendChild(row);
            });
        }
    }

    async function guardarProducto() {
        // Validar formulario
        const form = document.getElementById('productoForm');
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            Swal.fire('Advertencia', 'Por favor complete todos los campos requeridos', 'warning');
            return;
        }
        
        const clave = document.getElementById('clave').value.trim();
        const nombre = document.getElementById('nombre').value.trim();
        const tipoProducto = document.getElementById('tipo_producto').value;
        const activo = document.getElementById('activo').checked;
        
        if (!clave || !nombre || !tipoProducto) {
            Swal.fire('Advertencia', 'Por favor complete todos los campos requeridos', 'warning');
            return;
        }
        
        const data = {
            clave: clave,
            nombre: nombre,
            tipo_producto: parseInt(tipoProducto),
            activo: activo,
            proveedores: proveedoresData.map(p => ({
                proveedor: p.proveedor,
                clave_proveedor: p.clave_proveedor,
                costo: p.costo,
                activo: p.activo
            }))
        };
        
        try {
            let url = `${API_BASE_URL}/productos/`;
            let method = 'POST';
            
            if (MODO === 'editar' && PRODUCTO_ID) {
                url = `${API_BASE_URL}/productos/${PRODUCTO_ID}/`;
                method = 'PUT';
            }
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                Swal.fire({
                    icon: 'success',
                    title: MODO === 'crear' ? 'Producto creado' : 'Producto actualizado',
                    text: 'La operación se realizó correctamente',
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.href = '/productos/';
                });
            } else {
                const error = await response.json();
                let errorMsg = 'No se pudo guardar el producto';
                
                if (error.clave) {
                    errorMsg = error.clave[0];
                } else if (error.error) {
                    errorMsg = error.error;
                }
                
                Swal.fire('Error', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Error al guardar producto:', error);
            Swal.fire('Error', 'No se pudo guardar el producto', 'error');
        }
    }
</script>
{% endblock %}